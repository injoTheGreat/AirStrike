<?xml version="1.0" encoding="utf-8"?>
<s:WindowedApplication xmlns:fx="http://ns.adobe.com/mxml/2009"
						xmlns:mx="library://ns.adobe.com/flex/mx"
						xmlns:s="library://ns.adobe.com/flex/spark"
						creationComplete="appCreationComplete(event)"
						enterFrame="onEnterFrame(event)"
						click="onClick(event)"
						mouseMove="onMouseMove(event)"
						mouseUp="onMouseUp(event)"
						mouseDown="onMouseDown(event)"
						applicationComplete="onAppCompleted(event)"
						showStatusBar="false">
	<fx:Script>
		<![CDATA[
			import mx.collections.ArrayCollection;
			import mx.events.FlexEvent;
			
			import game.MainManager;
			
			
			[Embed(source="/assets/images/sound_on.png")]
			private static const SOUND_ON:Class;

			[Embed(source="/assets/images/sound_off.png")]
			private static const SOUND_OFF:Class;

			private var gameStarted:Boolean = false;
			private var keyCodes:ArrayCollection = new ArrayCollection();

			//application created
			protected function appCreationComplete(event:FlexEvent):void
			{
				Mouse.hide();
				MainManager.inst.init(gamePanel.width, gamePanel.height);

				gameStarted = true;
				
				/*gamePanel.graphics.clear();
				gamePanel.graphics.beginBitmapFill(MainManager.inst.backBuffer);
				gamePanel.graphics.drawRect(0, 0, gamePanel.width, gamePanel.height);
				gamePanel.graphics.endFill();*/
			}

			//enter frame handler
			protected function onEnterFrame(event:Event):void
			{
				if (gameStarted)
				{
					if (keyCodes.length > 0)
					{
						MainManager.inst.keyDown(keyCodes.toArray());
					}
					
					MainManager.inst.render();

					gamePanel.graphics.clear();
					gamePanel.graphics.beginBitmapFill(MainManager.inst.backBuffer);
					gamePanel.graphics.drawRect(0, 0, gamePanel.width, gamePanel.height);
					gamePanel.graphics.endFill();
				}
			}

			protected function onClick(event:MouseEvent):void
			{
				MainManager.inst.mouseClick(event);
			}

			protected function onMouseMove(event:MouseEvent):void
			{
				MainManager.inst.mouseMove(event);
			}

			protected function onMouseUp(event:MouseEvent):void
			{
				MainManager.inst.mouseUp(event);
			}

			protected function onMouseDown(event:MouseEvent):void
			{
				MainManager.inst.mouseDown(event);
			}

			protected function onKeyDown(event:KeyboardEvent):void
			{
				if (!keyCodes.contains(event.keyCode))
					keyCodes.addItem(event.keyCode);
			}

			protected function onKeyUp(event:KeyboardEvent):void
			{
				if (keyCodes.contains(event.keyCode))
				{
					keyCodes.removeItemAt(keyCodes.getItemIndex(event.keyCode))
				}
			}

			protected function onAppCompleted(event:FlexEvent):void
			{
				stage.addEventListener(KeyboardEvent.KEY_DOWN, onKeyDown);
				stage.addEventListener(KeyboardEvent.KEY_UP, onKeyUp);
			}
			
			protected function gameSound_clickHandler(event:MouseEvent):void
			{
//				MainManager.inst.soundEnabled = !MainManager.inst.soundEnabled;
			}
			
		]]>
	</fx:Script>
	<fx:Declarations>
		<!-- Place non-visual elements (e.g., services, value objects) here -->
	</fx:Declarations>
	
	<mx:Canvas id="gamePanel"
			   width="100%"
			   height="100%"/>

	<s:Image id="gameSound" 
			 source="{MainManager.inst.soundEnabled ? new SOUND_ON().bitmapData : new SOUND_OFF().bitmapData}"
			 scaleMode="letterbox" 
			 smoothingQuality="high"
			 smooth="true"
			 width="25"
			 height="25"
			 left="20"
			 includeInLayout="false"
			 visible="true"
			 click="gameSound_clickHandler(event)"
			 top="20"/>
	
	<s:Label color="#FFFFFF"
			 text="{MainManager.inst.kills}"
			 fontSize="20"
			 fontWeight="bold"
			 right="20"
			 top="20"/>
	
</s:WindowedApplication>
